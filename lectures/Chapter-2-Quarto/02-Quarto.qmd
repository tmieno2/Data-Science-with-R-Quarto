---
title: "02-Using Quarto to Create Documents"
format:
  revealjs: 
    theme: [default, ../custom.scss]
    fontsize: 1.6em
    callout-icon: false
    scrollable: true
    echo: true
    fig-dpi: 400
filters:
  - webr
---

```{r}
#| include: false 
library(ggplot2) 
library(dplyr) 
library(here) 
```

# Table of contents

1. [What is Quarto?](#intro)
2. [Chunk options](#objects)
3. [Caching](#cache)
4. [YAML](#yaml)
5. [Directory](#directory)
5. [Output types](#output)

# Quarto: Introduction

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Quarto: Introduction

::: {.panel-tabset}
### What is and why Quarto?

+ It allows you to effortlessly generate documents that can print both R codes and their outcomes (this lecture note is indeed written using **Quarto**) in a single document.

+ It is useful when you report the analysis you conducted and its source R codes to your advisor or anyone you report to (as long as that person understands R).

+ The power of Quarto goes well beyond just creating a simple html document. The full power of Quarto is on display [here](https://quarto.org/docs/gallery/).


###  Using WORD?

+ It would be a real pain to do so because you need to copy and paste all the R codes you run and the results onto WORD **manually**. 
 
+ Often times, copied R codes and results are very much likely to be badly formatted when pasting them

+ Quarto obviates the need of repeating copying and pasting when you would like to communicate what you did (R codes) and what you found (results) without worrying too much about formatting.

### Generating a report using Quarto

Generating a report using Quarto is a two-step process:

1. Create an Quarto file (file with .qmd as an extension) with regular texts and R codes mixed inside it. 
  + You use a special syntax to let the computer know which parts of the file are simple texts and which parts are R codes.

2. Tell the computer to process the qmd file (a click of a button on RStudio, or use the `render()` function)
  + The computer runs the R codes and get their outcomes
  + Combine the text parts, R codes, and their results to produce a document
:::
<!--end of panel-->

# Quarto: the Basics

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Quarto: the Basics

::: {.panel-tabset}


### R code chunks

A qmd file would consist of two types of inputs:

+ R code chunks
+ Regular texts

:::{.callout-important title="Special Syntax"}

We can indicate R codes chunks by placing R codes inside a special syntax.

````{verbatim}
```{r}
codes
```
````
:::

:::{.callout-note title="Direction"}
Take a look at **qmd_sample.qmd**, which can be downloaded from [here](https://tmieno2.github.io/AECN-Data-Science-R/Chapter-2-Rmarkdown/sample_rmd.Rmd).

+ R codes `summary(cars)` and `plot(pressure)` are enclosed individually by the special syntax

+ So, in this qmd file, R knows that it should treat them as R codes, but not regular texts. 

+ On the other hand, any texts that are not enclosed by the special syntax would be recognized as regular text.
:::

### Let's knit

The process of compiling an qmd file to produce a document is called **knitting**.

+ The easiest way to knit is to hit the Knit button located at the top of the code pane (upper left pane by default)

+ Alternatively, you can use the `render()` function to knit like below:

```{r eval = F}
render("sample_rmd.Rmd")
```

### qmd v.s. output

Inspect the qmd file and its output document:

::: {.columns}

::: {.column width="50%"}
**qmd side**

1. lines 1-15: a **YAML header** where you control the aesthetics of the output document (more on this later) 
2. lines 36-38: texts not enclosed by the special syntax
3. lines 40-42: `summary(cars)` is an R code, which is enclosed by the special syntax
:::
<!--end of the 1st column-->
::: {.column width="50%"}
**html side**

1. lines 1-15: nothing 
2. lines 36-38: printed as regular texts 
3. lines 40-42: the R code and its results printed
:::
<!--end of the 2nd column-->
:::
<!--end of the columns-->

### Inline code

You can refer to an R object previously defined in line and display its content in line:

.content-box-red[**Direction**]

See lines 62-68 of the qmd file

### Markdown basics

+ header
+ make a list
+ font
+ code highlighting
+ inline math
+ math
+ web link
+ citation

.content-box-red[**Direction**]

Compare Chapter 2 of the qmd file and its output html file

### Caveat

+ When you knit an qmd file and create a report, R creates an R session/environment that is completely <span style = "color: blue;"> independent </span> of whatever R sessions or environments you may have on your RStudio. 

+ This means that when you knit an qmd file, you cannot refer to R objects you have defined on your current R session.
:::
<!--end of panel-->

# Chunk options

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Chunk options

::: {.panel-tabset}

### What?

Chunk options are special codes inside R code chunks to control how the code chunks operate.

Here are some example options:

+ `echo`
+ `eval`
+ `message`
+ `warning`
+ `results`
+ `include`
+ `cache`
+ `fig.cap`, `fig-height`, etc

### Example: `echo`

+ Inspect the qmd file and its output document and observe that 

  - From the R code chunk with `summary(cars)`, the code itself and its outcome are presented in the output
  - From the R code chunk with `plot(pressure)`, only its outcome is presented in the output

+ This is because of the chunk option `echo = FALSE` in the second R code chunk

### Various options

::: {.panel-tabset}

#### `echo` and `eval`

.footnote[
<sup>1</sup> Values in red indicates that they are the default values
]

.content-box-green[**Chunk option: echo**]

+ `echo` (<span style="color:red"> TRUE </span> or FALSE): specify whether the R codes appear in the  output document or not

+ `eval` (<span style="color:red"> TRUE </span> or FALSE): specify whether the R codes are evaluated or not

:::{.callout-note title=Direction}
Inspect the qmd file (lines 95-115) and its output document to see their effects.
:::

#### `message` and `warning`
+ `message` (TRUE or <span style="color:red"> FALSE </span>): specify weather messages associated with R codes evaluation appear in the output document or not

+ `warning` (TRUE or <span style="color:red"> FALSE </span>): specify weather warnings associated with R codes evaluation appear in the output document or not


.content-box-red[**Direction**]

Inspect the rmd file (lines 119-140) and its output document

#### `results`

`results` (<span style="color:red"> markup </span>, hide, asis)

+ `hide`: hides all the results including warnings and messages
+ `asis`: the outputs of the R codes are printed as-is without any suitable formatting (which the default option `markup` does)

<br>

.content-box-red[**Direction**]

Inspect the rmd file (lines 144-156) and its output document

.footnote[
<sup>1</sup> Values in red indicates that they are the default values <br>
]

#### `include`

`include = FALSE` is equivalent to having `eval = TRUE, echo = FALSE, results = "hide"`

<br>

.content-box-red[**Direction**]

Inspect the rmd file (lines 160-173) and its output document

#### figure-related

.content-box-green[**Chunk option for figure**]

+ `fig.align`: 'default', 'center', 'left', 'right'
+ `fig.width`: in inches
+ `fig.height`: in inches
+ `fig.cap`: figure caption

<br>

.content-box-red[**Direction**]

Play with these options. See [here](https://yihui.org/knitr/options/) for more chunk options.

:::
<!--end of panel-->

### Specify chunk options globally

::: {.panel-tabset}

#### What and why?

Sometimes, it is useful to set chunk options that apply globally (for the entire documents).

For example,

+ You are writing a term paper and the instructor may want to see only results, but not R codes.
+ You do not want any of the R codes to appear on the output document, but `echo = TRUE` is the default.

#### How

You can use `opts_chunk$set()` from the **knitr** package to set chunk options globally.

```{r , eval = F}
opts_chunk$set(
  echo = FALSE,
  messages = FALSE,
  warnings = FALSE,
  fig.align = "center",
  fig.width = 5,
  fig.height = 4
)
```

.content-box-red[**Direction**]

Remove `eval = F` from the R chunk at line 17 and knit.

.content-box-green[**Important**]: Local option overrides the global option.
:::
<!--end of panel-->

:::
<!--end of panel-->

# Caching

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Caching


::: {.panel-tabset}

### What?

+ In the course of creating a document using Rmarkdown, You are going to hit the "Knit" button numerous times when you are writing a report to check whether the final output looks fine. 

+ Every time you knit, all the R code chunks are evaluated, which is inefficient because R has evaluated those R code chunks before.

+ So, if we can somehow store the results of R code chunks (caching), and then let R call up the saved results instead of re-evaluating the codes all over again, we can save lots of time.

+ The benefit of doing so is greater when the processing time of the codes is longer. Caching can be done by adding `cache==TRUE` as a chunk option. 

+ By adding the option, once an R chunk is processed, its results are saved and can be reused again by R later when you compile the document again. 

###

.content-box-red[**Direction**]

+ change `eval = F` to `eval = T` in the **cache_1** chunk
+ knit and confirm that **sample_rmd_cache** and **sample_rmd_files** folders are created
+ knit again and observe that the knitting process is much faster now

###
When any part of the R codes within a cached R code chunk is changed, R is smart enough to recognize the change and evaluate the R code chunk again without using the cached results for the chunk. 

.content-box-red[**Direction**]

Change `y = 1 + x + v` to `y = 1 + 2 * x +v` in the **cache_1** chunk and knit

###

+ Sometimes, your R codes within an cached R code chunk have not changed, but the content of a dataset used in the R code chunk may have changed. 

+ In such a case, R is unable to recognize the change in the content of the dataset. 

.content-box-red[**Direction**]

+ change `eval = F` to `eval = T` in the `cache_2` chunk and knit
+ change `y = 1 + 2 * x + v` back to `y = 1 + x +v` and knit (notice that the printed number from `cache_2` did not change)

###

+ To R, everything in the `cache_2` chunk looks the same as they only look at the code texts, but not the contents of R objects. 
+ Therefore, R would call up the saved results instead of rerunning the R codes, which is not what you want.
+ You can use the `dependson` option to make R recognize any changes in cached R objects 

.content-box-green[**Direction**]

Add `dependson = "cache_1"` to the `cache_2` chunk as an option and knit again.
:::
<!--end of panel-->

# YAML

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## YAML

::: {.panel-tabset}

### What?
At the very beginning of an rmd file, you have a YAML header, where you specify how the resulting documents look like.

.content-box-green[**Example**]

```
---
title: "Reporting using Rmarkdown"
author: "Taro Mieno"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
---
```

:::{.callout-note title=Direction}
+ Try other themes and highlight methods found [here](https://bookdown.org/yihui/rmarkdown/html-document.html#appearance-and-style)
+ Visit [here](https://bookdown.org/yihui/rmarkdown/html-document.html) for the other options.
:::

:::
<!--end of panel-->


# Directory

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Directory

::: {.panel-tabset}
### Reading Files

Suppose you are interested in reading a dataset file like this:

```{r eval = F}
read.csv("corn_price.csv")
```

<br>

.content-box-red[**Important**]:

By default, RStudio looks for **corn_price.csv** in the same folder in which the Rmd file is located. 

<br>

.content-box-green[**So,**]

+ In my case, the sample_rmd.rmd is located in `r here("Chapter-2-Rmarkdown")`.

+ So, RStudio tries to find `r here("Chapter-2-Rmarkdown", "corn_price.csv")`.

+ If the file is not in the directory, RStudio won't be able to find the file to import and returns an error. Clearly, all the subsequent actions dependent on the dataset will not run.

###

To avoid errors in reading files, there are three options:

<br>

.content-box-green[**Option 1.**] (recommended for a beginner)

Put all the datasets you intend to use in the same directory in which your rmd file is located

.content-box-green[**Option 2.**]

If the file is not in the directory, supply the full path to the file like this

```{r eval = F}
read.csv("~/Dropbox/TeachingUNL/Data-Science-with-R/Chapter-2-Rmarkdown/corn_price.csv")
```

.content-box-green[**Option 3.**]

Tell R to look for a specific directory for datasets by setting a working directory using `opts_knit$set(root.dir = directory)` at the beginning

```{r eval = F}
opts_knit$set(root.dir = "~/Dropbox/TeachingUNL/Data-Science-with-R/Chapter-2-Rmarkdown/")
```

:::
<!--end of panel-->


# Output types

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>

## Output types

::: {.panel-tabset}

###

+ html 
+ Word
+ pdf

<br>

.content-box-green[**How**]

To select the output type, first click on the black triangle button next to the "Knit" button, and then select your preferred option type.

+ By far the preferred version of the three is html if you do not intend to print out the output document. 
+ html is void of the concept of **page**. Consequently, you do not have to worry about how you should organize texts, tables, and figures within a page (fixed amount of space). 
+ The formatting of figure and tables can be screwed up in Word

### Interactive features

html is much more powerful than pdf or WORD in the sense that it is interactive.

**htmlwidgets**: tools to generate interactive contents using R

See the list of htmlwidgets [here](https://www.htmlwidgets.org/)

### Interactive features: table

`datatable()` from the `DT` package lets you create an interactive table

```{r echo = F, fig.width = 9, fig.height = 7}
library(tidyverse)
library(DT)

iris %>% datatable(
  extensions = "Buttons",
  options = list(
    dom = "Blfrtip",
    buttons = c("copy", "csv", "excel", "pdf", "print"),
    lengthMenu = list(
      c(10, 25, 50, -1),
      c(10, 25, 50, "All")
    )
  )
)
```

### time-series data

```{r fig.width = 9, fig.height = 5}
library(dygraphs)
dygraph(nhtemp, main = "New Haven Temperatures") %>%
  dyRangeSelector(dateWindow = c("1920-01-01", "1960-01-01"))
```

### ggplot2 figures

```{r fig.width = 9, fig.height = 5}
library(ggplot2)
library(plotly)
p <- ggplot(data = diamonds) +
  geom_bar(aes(x = cut, fill = clarity), position = "dodge")

ggplotly(p)
```

:::
<!--end of panel-->

## Resources

Here is a list of some useful resources to learn Rmarkdown.   

+ [R Markdown: The Definitive Guide](<https://bookdown.org/yihui/rmarkdown/>)
+ [Introduction to R markdown by Rstudio](<http://rmarkdown.rstudio.com/lesson-1.html>)
+ [Cheat sheet by Rstudio](<https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=2&ved=0ahUKEwj97pD72vjVAhVk74MKHYBqBMsQFgg0MAE&url=https%3A%2F%2Fwww.rstudio.com%2Fwp-content%2Fuploads%2F2015%2F02%2Frmarkdown-cheatsheet.pdf&usg=AFQjCNHTjjlYFQjxyljotaYc6U4Wagw-CQ>)

